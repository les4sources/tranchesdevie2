<% content_for :title, "Modifier la commande #{@order.order_number}" %>
<% content_for :layout, "admin" %>

<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900">Modifier la commande <%= @order.order_number %></h1>
  <p class="mt-1 text-sm text-gray-600">Modifiez une commande existante en changeant le client, le jour de cuisson, les quantit√©s ou le statut.</p>
</div>

<% if @order.errors.any? %>
  <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4">
    <h2 class="text-sm font-semibold text-red-800">Veuillez corriger les erreurs suivantes :</h2>
    <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-red-700">
      <% @order.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
  <%= form_with model: @order, url: admin_order_path(@order), method: :patch, local: true, data: { controller: "order-calculator", order_calculator_customers_value: @customers.map { |c| { id: c.id, discount_percent: c.effective_discount_percent } }.to_json } do |f| %>
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <div data-controller="searchable-select" data-searchable-select-placeholder-value="Choisir un client...">
        <%= f.label :customer_id, "Client", class: "block text-sm font-medium text-gray-700" %>
        <% customer_options = @customers.sort_by { |c| [c.last_name.to_s.downcase, c.first_name.to_s.downcase] }.map do |customer|
             label = [customer.last_name&.upcase, customer.first_name].compact.join(' ').squish
             [label, customer.id]
           end %>
        <%= f.select :customer_id,
                     options_for_select(customer_options, @order.customer_id),
                     { include_blank: "S√©lectionner un client" },
                     class: "mt-1 #{admin_input_class}",
                     data: { searchable_select_target: "select", order_calculator_target: "customerSelect", action: "change->order-calculator#onCustomerChange" } %>
      </div>

      <div>
        <%= f.label :bake_day_id, "Jour de cuisson", class: "block text-sm font-medium text-gray-700" %>
        <% bake_day_options = @bake_days.map do |bake_day|
             label = bake_day.baked_on.strftime("%A %d/%m/%Y")
             [label, bake_day.id]
           end %>
        <%= f.select :bake_day_id,
                     options_for_select(bake_day_options, @order.bake_day_id),
                     { include_blank: "S√©lectionner un jour" },
                     class: "mt-1 #{admin_input_class}" %>
      </div>
    </div>

    <div class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium text-gray-900">Produits et variantes</h2>
        <button type="button"
                class="text-sm font-medium text-indigo-600 hover:text-indigo-500"
                data-action="order-calculator#resetQuantities">
          R√©initialiser les quantit√©s
        </button>
      </div>

      <% category_labels = { "breads" => "üçû Pains", "dough_balls" => "ü•ê P√¢tons" } %>
      <% grouped_products = @products.group_by(&:category) %>

      <div class="mt-4 space-y-8">
        <% grouped_products.each do |category, products| %>
          <div>
            <h3 class="text-base font-semibold text-gray-700 mb-3"><%= category_labels[category] || category.titleize %></h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
              <% products.each do |product| %>
                <% active_variants = product.product_variants.active %>
                <% next if active_variants.empty? %>
                <% row_total_cents = active_variants.sum { |variant| (@selected_quantities[variant.id] || 0) * variant.price_cents } %>
                <% has_selection = active_variants.any? { |v| (@selected_quantities[v.id] || 0) > 0 } %>

                <div class="rounded-xl border-2 bg-white p-4 transition-all duration-200 <%= has_selection ? 'border-indigo-400 shadow-md ring-1 ring-indigo-100' : 'border-gray-200 shadow-sm' %>"
                     data-order-calculator-target="productCard"
                     data-product-id="<%= product.id %>">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-bold text-gray-900"><%= product.name %></h4>
                    <span class="text-sm font-semibold tabular-nums <%= has_selection ? 'text-indigo-600' : 'text-gray-400' %>"
                          data-order-calculator-target="rowSubtotal"
                          data-product-id="<%= product.id %>">
                      <%= row_total_cents > 0 ? number_to_currency(row_total_cents / 100.0, unit: "‚Ç¨", separator: ",", delimiter: "") : "" %>
                    </span>
                  </div>

                  <div class="space-y-2">
                    <% active_variants.each do |variant| %>
                      <% input_value = @selected_quantities[variant.id] || 0 %>
                      <% is_active = input_value > 0 %>
                      <div class="flex items-center justify-between rounded-lg px-3 py-2 <%= is_active ? 'bg-indigo-50' : 'bg-gray-50' %>"
                           data-order-calculator-target="variantRow"
                           data-variant-id="<%= variant.id %>">
                        <div class="flex-1 min-w-0 mr-3">
                          <span class="text-sm font-medium <%= is_active ? 'text-indigo-900' : 'text-gray-700' %>"><%= variant.name %></span>
                          <span class="text-xs text-gray-400 ml-1"><%= number_to_currency(variant.price_euros, unit: "‚Ç¨", separator: ",", delimiter: "") %></span>
                        </div>
                        <div class="flex items-center space-x-1">
                          <button type="button"
                                  class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-300 bg-white text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                                  data-action="order-calculator#decrement"
                                  data-variant-id="<%= variant.id %>"
                                  tabindex="-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
                          </button>
                          <input type="number"
                                 name="order[variant_quantities][<%= variant.id %>]"
                                 value="<%= input_value %>"
                                 min="0"
                                 step="1"
                                 class="w-12 text-center text-sm font-semibold border-0 bg-transparent focus:ring-0 tabular-nums <%= is_active ? 'text-indigo-700' : 'text-gray-400' %>"
                                 data-order-calculator-target="quantity"
                                 data-price-cents="<%= variant.price_cents %>"
                                 data-product-id="<%= product.id %>"
                                 data-variant-id="<%= variant.id %>"
                                 data-action="input->order-calculator#recalculate change->order-calculator#recalculate" />
                          <button type="button"
                                  class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-indigo-300 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                                  data-action="order-calculator#increment"
                                  data-variant-id="<%= variant.id %>"
                                  tabindex="-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                          </button>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="mt-4 rounded-md bg-gray-50 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-900">Montant indicatif (calcul automatique)</p>
            <p class="text-xs text-gray-600" data-order-calculator-target="discountInfo">
              Ce montant est calcul√© √† partir des quantit√©s saisies.
            </p>
          </div>
          <p class="text-lg font-semibold text-indigo-600" data-order-calculator-target="totalAmount">
            <%= number_to_currency(@calculated_total_cents / 100.0, unit: "‚Ç¨", separator: ",", delimiter: "") %>
          </p>
        </div>
        <div class="mt-2 hidden" data-order-calculator-target="discountMessage">
          <p class="text-xs text-green-600 font-medium">
            <span data-order-calculator-target="discountText"></span>
          </p>
        </div>
      </div>
    </div>

    <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2">
      <div>
        <label for="order_final_total_euros" class="block text-sm font-medium text-gray-700">Montant final de la commande *</label>
        <% final_total_value = params.dig(:order, :final_total_euros) || (@order.total_cents.present? ? (@order.total_cents / 100.0) : nil) %>
        <div class="mt-1">
          <%= number_field_tag "order[final_total_euros]",
                               final_total_value,
                               min: 0,
                               step: 0.01,
                               required: true,
                               class: admin_input_class %>
        </div>
        <% if @order.errors[:total_cents].present? %>
          <p class="mt-1 text-sm text-red-600"><%= @order.errors[:total_cents].first %></p>
        <% end %>
      </div>

      <div>
        <fieldset>
          <legend class="block text-sm font-medium text-gray-700">Statut de la commande</legend>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <% status_options = {
              pending: "En attente",
              unpaid: "Non pay√©e",
              paid: "Pay√©e",
              ready: "Pr√™te",
              picked_up: "R√©cup√©r√©e",
              no_show: "Non r√©cup√©r√©e",
              cancelled: "Annul√©e"
            } %>
            <% status_options.each do |value, label| %>
              <label class="flex items-center space-x-2 rounded-md border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm">
                <%= f.radio_button :status, value, class: "text-indigo-600 focus:ring-indigo-500" %>
                <span><%= label %></span>
              </label>
            <% end %>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="mt-6">
      <label class="inline-flex items-center space-x-2 text-sm text-gray-700">
        <%= f.check_box :requires_invoice, class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" %>
        <span>Il faut une facture pour cette commande</span>
      </label>
    </div>

    <div class="mt-8 flex justify-end space-x-3">
      <%= link_to "Annuler", admin_order_path(@order), class: "inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" %>
      <%= f.submit "Modifier la commande", class: "inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
    </div>
  <% end %>
</div>

