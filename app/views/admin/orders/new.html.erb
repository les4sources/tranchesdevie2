<% content_for :title, "Nouvelle commande" %>
<% content_for :layout, "admin" %>

<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900">Nouvelle commande</h1>
  <p class="mt-1 text-sm text-gray-600">Créez une commande manuellement en sélectionnant un client, un jour de cuisson et les quantités souhaitées.</p>
</div>

<% if @order.errors.any? %>
  <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4">
    <h2 class="text-sm font-semibold text-red-800">Veuillez corriger les erreurs suivantes :</h2>
    <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-red-700">
      <% @order.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
  <%= form_with model: @order, url: admin_orders_path, local: true, data: { controller: "order-calculator", order_calculator_customers_value: @customers.map { |c| { id: c.id, discount_percent: c.group&.discount_percent || 0 } }.to_json } do |f| %>
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <div>
        <%= f.label :customer_id, "Client", class: "block text-sm font-medium text-gray-700" %>
        <% customer_options = @customers.map do |customer|
             label = [customer.last_name&.upcase, customer.first_name].compact.join(' ').squish
             [label, customer.id]
           end %>
        <%= f.select :customer_id,
                     options_for_select(customer_options, @order.customer_id),
                     { include_blank: "Sélectionner un client" },
                     class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                     data: { order_calculator_target: "customerSelect", action: "change->order-calculator#onCustomerChange" } %>
      </div>

      <div>
        <%= f.label :bake_day_id, "Jour de cuisson", class: "block text-sm font-medium text-gray-700" %>
        <% bake_day_options = @bake_days.map do |bake_day|
             label = bake_day.baked_on.strftime("%A %d/%m/%Y")
             [label, bake_day.id]
           end %>
        <%= f.select :bake_day_id,
                     options_for_select(bake_day_options, @order.bake_day_id),
                     { include_blank: "Sélectionner un jour" },
                     class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>
    </div>

    <div class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium text-gray-900">Produits et variantes</h2>
        <button type="button"
                class="text-sm font-medium text-indigo-600 hover:text-indigo-500"
                data-action="order-calculator#resetQuantities">
          Réinitialiser les quantités
        </button>
      </div>

      <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200">
        <% max_variant_count = @max_variant_count || 0 %>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500">Produit</th>
              <% if max_variant_count.positive? %>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500" colspan="<%= max_variant_count %>">Variantes</th>
              <% end %>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-500">Sous-total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 bg-white">
            <% @products.each do |product| %>
              <% active_variants = product.product_variants.active %>
              <% next if active_variants.empty? %>
              <% blank_cells = max_variant_count - active_variants.size %>
              <% row_total_cents = active_variants.sum { |variant| (@selected_quantities[variant.id] || 0) * variant.price_cents } %>
              <tr class="bg-gray-50">
                <th class="whitespace-nowrap px-4 py-4 text-sm font-semibold text-gray-900" rowspan="2"><%= product.name %></th>
                <% active_variants.each do |variant| %>
                  <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500">
                    <div><%= variant.name %></div>
                    <div class="text-[11px] text-gray-400"><%= number_to_currency(variant.price_euros, unit: "€", separator: ",", delimiter: "") %></div>
                  </th>
                <% end %>
                <% blank_cells.times do %>
                  <th class="px-4 py-3"></th>
                <% end %>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-500" rowspan="2">Sous-total</th>
              </tr>
              <tr>
                <% active_variants.each do |variant| %>
                  <% input_value = @selected_quantities[variant.id] || 0 %>
                  <td class="px-4 py-4 text-center">
                    <%= number_field_tag "order[variant_quantities][#{variant.id}]",
                                         input_value,
                                         min: 0,
                                         step: 1,
                                         class: "w-24 rounded-md border-gray-300 text-center shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                                         data: {
                                           order_calculator_target: "quantity",
                                           price_cents: variant.price_cents,
                                           product_id: product.id,
                                           action: "input->order-calculator#recalculate change->order-calculator#recalculate"
                                         } %>
                  </td>
                <% end %>
                <% blank_cells.times do %>
                  <td class="px-4 py-4 bg-gray-50"></td>
                <% end %>
                <td class="whitespace-nowrap px-4 py-4 text-right text-sm font-medium text-gray-900"
                    data-order-calculator-target="rowSubtotal"
                    data-product-id="<%= product.id %>">
                  <%= number_to_currency(row_total_cents / 100.0, unit: "€", separator: ",", delimiter: "") %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 rounded-md bg-gray-50 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-900">Montant indicatif (calcul automatique)</p>
            <p class="text-xs text-gray-600" data-order-calculator-target="discountInfo">
              Ce montant est calculé à partir des quantités saisies.
            </p>
          </div>
          <p class="text-lg font-semibold text-indigo-600" data-order-calculator-target="totalAmount">
            <%= number_to_currency(@calculated_total_cents / 100.0, unit: "€", separator: ",", delimiter: "") %>
          </p>
        </div>
        <div class="mt-2 hidden" data-order-calculator-target="discountMessage">
          <p class="text-xs text-green-600 font-medium">
            <span data-order-calculator-target="discountText"></span>
          </p>
        </div>
      </div>
    </div>

    <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2">
      <div>
        <label for="order_final_total_euros" class="block text-sm font-medium text-gray-700">Montant final de la commande *</label>
        <% final_total_value = params.dig(:order, :final_total_euros) || (@order.total_cents.present? ? (@order.total_cents / 100.0) : nil) %>
        <div class="mt-1">
          <%= number_field_tag "order[final_total_euros]",
                               final_total_value,
                               min: 0,
                               step: 0.01,
                               required: true,
                               class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
        </div>
        <% if @order.errors[:total_cents].present? %>
          <p class="mt-1 text-sm text-red-600"><%= @order.errors[:total_cents].first %></p>
        <% end %>
      </div>

      <div>
        <fieldset>
          <legend class="block text-sm font-medium text-gray-700">Statut de la commande</legend>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <% status_options = {
              unpaid: "Non payée",
              paid: "Payée",
              ready: "Prête",
              picked_up: "Retirée"
            } %>
            <% status_options.each do |value, label| %>
              <label class="flex items-center space-x-2 rounded-md border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm">
                <%= f.radio_button :status, value, class: "text-indigo-600 focus:ring-indigo-500" %>
                <span><%= label %></span>
              </label>
            <% end %>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="mt-6">
      <label class="inline-flex items-center space-x-2 text-sm text-gray-700">
        <%= f.check_box :requires_invoice, class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" %>
        <span>Il faut une facture pour cette commande</span>
      </label>
    </div>

    <div class="mt-8 flex justify-end space-x-3">
      <%= link_to "Annuler", admin_orders_path, class: "inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" %>
      <%= f.submit "Créer la commande", class: "inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
    </div>
  <% end %>
</div>

