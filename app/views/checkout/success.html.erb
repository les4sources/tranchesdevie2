<% content_for :title, "Commande confirmée" %>

<div class="max-w-2xl mx-auto text-center" data-checkout-success-page>
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
    <div class="mb-4">
      <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>

    <h1 class="text-2xl font-bold text-gray-900 mb-4">Commande confirmée !</h1>
    
    <% if @order %>
      <p class="text-gray-600 mb-4">
        Ta commande <strong><%= @order.order_number %></strong> a été confirmée.
      </p>
      
      <% if @order.unpaid? %>
        <p class="text-gray-600 mb-4">
          Tu paieras en liquide lors du retrait de ta commande.
        </p>
      <% end %>
      
      <p class="text-gray-600 mb-6">
        Tu recevras un SMS de confirmation lorsque ta commande est cuite.
      </p>

      <%= link_to "Voir ma commande", order_path(@order.public_token), class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
    <% else %>
      <p class="text-gray-600 mb-6">
        Ton paiement a été traité avec succès.
      </p>
    <% end %>

    <div class="mt-6">
      <%= link_to "Retour au catalogue", catalog_path, class: "text-blue-600 hover:text-blue-800" %>
    </div>
  </div>

  <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-8">
    <iframe data-tally-src="https://tally.so/embed/yPPAbX?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="482" frameborder="0" marginheight="0" marginwidth="0" title="Feedback sur le site web de Tranches de Vie"></iframe>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
  // Fonction pour lancer l'effet confetti
  function launchConfetti() {
    if (typeof confetti === 'undefined') {
      console.error('canvas-confetti n\'est pas chargé');
      return;
    }

    const duration = 3000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

    function randomInRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = 50 * (timeLeft / duration);
      
      confetti({
        ...defaults,
        particleCount,
        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
      });
      confetti({
        ...defaults,
        particleCount,
        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
      });
    }, 250);
  }

  // Vérifier si on est sur la page de succès
  function isCheckoutSuccessPage() {
    return document.querySelector('[data-checkout-success-page]') !== null;
  }

  // Fonction pour initialiser le confetti une fois la bibliothèque chargée
  function initConfetti() {
    if (!isCheckoutSuccessPage()) {
      return; // Ne pas lancer si on n'est pas sur la page de succès
    }
    
    if (typeof confetti !== 'undefined') {
      launchConfetti();
    } else {
      // Attendre que le script soit chargé
      setTimeout(initConfetti, 100);
    }
  }

  // Lancer l'effet au chargement de la page (compatible avec Turbo)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConfetti);
  } else {
    initConfetti();
  }
  
  // Écouter les événements Turbo pour les navigations (uniquement si on est sur la page de succès)
  document.addEventListener('turbo:load', function() {
    if (isCheckoutSuccessPage() && typeof confetti !== 'undefined') {
      launchConfetti();
    }
  });
</script>

<script>
  // Script d'intégration Tally
  var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w,s.onload=v,s.onerror=v,d.body.appendChild(s);}
</script>
