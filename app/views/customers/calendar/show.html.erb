<% content_for :title, "Mon calendrier" %>

<div class="w-full mx-auto" data-controller="calendar"
     data-calendar-wallet-balance-value="<%= @wallet.balance_cents %>"
     data-calendar-committed-value="<%= @committed_cents %>"
     data-calendar-reload-url-value="<%= customers_wallet_reload_path %>"
     data-calendar-skip-wallet-value="<%= current_customer.skip_wallet_check? %>"
>
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Mon calendrier</h1>
    <div class="flex gap-3">
      <%= link_to "Mon compte", customers_account_path, class: "px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" %>
      <%= link_to "Portefeuille", customers_wallet_path, class: "px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" %>
    </div>
  </div>

  <% unless current_customer.skip_wallet_check? %>
    <!-- Solde du portefeuille -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
      <div class="flex items-center justify-between">
        <span class="text-gray-600">Solde du portefeuille</span>
        <span class="text-lg font-bold text-gray-900">
          <%= number_to_currency(@wallet.balance_euros, unit: '€', format: '%n %u') %>
        </span>
      </div>
      <% if @committed_cents > 0 %>
        <div class="flex items-center justify-between mt-1">
          <span class="text-sm text-gray-500">Engagé sur commandes planifiées</span>
          <span class="text-sm font-medium text-gray-500">
            − <%= number_to_currency(@committed_cents / 100.0, unit: '€', format: '%n %u') %>
          </span>
        </div>
      <% end %>
      <div class="flex items-center justify-between mt-1 pt-2 border-t border-gray-100">
        <span class="text-gray-600 font-medium">Disponible pour commander</span>
        <span class="text-xl font-bold <%= @available_balance_cents > 0 ? 'text-green-600' : 'text-red-600' %>">
          <%= number_to_currency(@available_balance_cents / 100.0, unit: '€', format: '%n %u') %>
        </span>
      </div>
      <% if @available_balance_cents <= 0 %>
        <div class="mt-2 p-2 bg-red-50 rounded text-sm text-red-700">
          Solde insuffisant pour commander.
          <%= link_to "Recharger mon portefeuille", customers_wallet_reload_path, class: "underline font-medium" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if @bake_days.empty? %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
      <p class="text-gray-600">Aucune date de cuisson disponible pour le moment.</p>
    </div>
  <% else %>
    <!-- Calendrier Desktop -->
    <div class="hidden lg:flex gap-6">
      <!-- Grille calendrier -->
      <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Prochaines dates de cuisson</h2>

        <div class="space-y-2">
          <% @bake_days.each do |bake_day| %>
            <% order = @planned_orders[bake_day.id] %>
            <% cut_off_passed = bake_day.cut_off_passed? %>
            <% can_order = !cut_off_passed %>

            <div class="flex items-center justify-between p-3 rounded-lg border transition-all <%= cut_off_passed ? 'bg-yellow-50 border-yellow-200' : 'bg-white border-gray-200 hover:border-green-300' %>"
                 data-bake-day-id="<%= bake_day.id %>"
                 data-can-order="<%= can_order %>"
                 data-bake-date="<%= l(bake_day.baked_on, format: '%A %d/%m').downcase %>"
                 <% if order %>
                 data-order-items="<%= order.order_items.map { |i| { product_variant_id: i.product_variant_id, qty: i.qty } }.to_json %>"
                 <% end %>
                 <% if can_order %>
                 data-action="dragover->calendar#dragOver dragleave->calendar#dragLeave drop->calendar#drop"
                 <% end %>>
              <div>
                <p class="font-medium text-gray-900">
                  <%= l(bake_day.baked_on, format: :long_with_day).capitalize %>
                </p>
                <% if cut_off_passed %>
                  <p class="text-xs text-yellow-600">Il n'est plus possible de commander pour ce jour de cuisson</p>
                <% end %>
              </div>

              <% if order %>
                <div class="flex items-center gap-3">
                  <div class="text-right">
                    <p class="text-sm text-gray-600">
                      <%= order.order_items.sum(&:qty) %> article(s)
                    </p>
                    <p class="font-semibold text-green-600">
                      <%= number_to_currency(order.total_cents / 100.0, unit: '€', format: '%n %u') %>
                    </p>
                  </div>
                  <% if can_order %>
                    <button type="button"
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                            data-action="calendar#openDayModal"
                            data-bake-day-id="<%= bake_day.id %>">
                      Modifier
                    </button>
                  <% end %>
                </div>
              <% elsif can_order %>
                <button type="button"
                        class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200"
                        data-action="calendar#openDayModal"
                        data-bake-day-id="<%= bake_day.id %>">
                  + Ajouter
                </button>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Sidebar produits (draggable) -->
      <div class="w-80 bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-h-[calc(100vh-12rem)] overflow-y-auto">
        <h2 class="text-lg font-medium text-gray-900 mb-2">Produits disponibles</h2>
        <p class="text-sm text-gray-500 mb-4">Glissez un produit sur une date ou cliquez sur "Ajouter"</p>

        <% @product_variants.group_by { |v| v.product.category }.each do |category, category_variants| %>
          <h3 class="text-xs font-semibold uppercase tracking-wide text-gray-400 mt-4 mb-2 first:mt-0"><%= product_category_heading(category) %></h3>

          <% category_variants.group_by(&:product).each do |product, variants| %>
            <div class="mb-3">
              <div class="flex items-center gap-2 mb-1">
                <% first_image = product.product_images.first&.image %>
                <% if first_image&.attached? %>
                  <%= image_tag first_image.variant(resize_to_limit: [32, 32]), class: "w-8 h-8 rounded object-cover" %>
                <% end %>
                <p class="text-sm font-semibold text-gray-800"><%= product.name %></p>
              </div>

              <div class="space-y-1">
                <% variants.each do |variant| %>
                  <div class="flex items-center justify-between px-2 py-1.5 rounded border border-gray-200 cursor-move hover:border-green-300 hover:bg-green-50 transition-all"
                       draggable="true"
                       data-variant-id="<%= variant.id %>"
                       data-price="<%= variant.price_cents %>"
                       data-product-name="<%= product.name %>"
                       data-variant-name="<%= variant.name %>"
                       data-product-category="<%= product_category_heading(category) %>"
                       data-action="dragstart->calendar#dragStart dragend->calendar#dragEnd">
                    <span class="text-sm text-gray-700"><%= variant.name %></span>
                    <span class="text-sm font-semibold text-gray-700">
                      <%= number_to_currency(variant.price_cents / 100.0, unit: '€', format: '%n %u') %>
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Vue mobile (liste) -->
    <div class="lg:hidden space-y-4">
      <% @bake_days.each do |bake_day| %>
        <% order = @planned_orders[bake_day.id] %>
        <% cut_off_passed = bake_day.cut_off_passed? %>
        <% can_order = !cut_off_passed %>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4"
             data-bake-day-id="<%= bake_day.id %>"
             data-can-order="<%= can_order %>"
             data-bake-date="<%= l(bake_day.baked_on, format: '%A %d/%m').downcase %>"
             <% if order %>
             data-order-items="<%= order.order_items.map { |i| { product_variant_id: i.product_variant_id, qty: i.qty } }.to_json %>"
             <% end %>>
          <div class="flex justify-between items-start">
            <div>
              <p class="font-medium text-gray-900">
                <%= l(bake_day.baked_on, format: :long_with_day).capitalize %>
              </p>
              <% if cut_off_passed %>
                <p class="text-xs text-yellow-600 mt-1">Il n'est plus possible de commander pour ce jour de cuisson</p>
              <% end %>
            </div>

            <% if can_order %>
              <button type="button"
                      class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700"
                      data-action="calendar#openDayModal"
                      data-bake-day-id="<%= bake_day.id %>">
                <%= order ? 'Modifier' : 'Commander' %>
              </button>
            <% end %>
          </div>

          <% if order %>
            <div class="mt-3 pt-3 border-t border-gray-100">
              <% order.order_items.each do |item| %>
                <div class="flex justify-between text-sm">
                  <span><%= item.product_variant.product.name %> (<%= item.qty %>)</span>
                  <span class="text-gray-600"><%= number_to_currency(item.qty * item.unit_price_cents / 100.0, unit: '€', format: '%n %u') %></span>
                </div>
              <% end %>
              <div class="flex justify-between font-semibold mt-2 pt-2 border-t border-gray-100">
                <span>Total</span>
                <span class="text-green-600"><%= number_to_currency(order.total_cents / 100.0, unit: '€', format: '%n %u') %></span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Modal pour ajouter/modifier une commande -->
  <div data-calendar-target="modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
      <!-- Overlay -->
      <div class="fixed inset-0 bg-black bg-opacity-50" data-action="click->calendar#closeModal"></div>

      <!-- Modal content -->
      <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-hidden">
        <!-- État formulaire -->
        <div data-calendar-target="modalForm">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900" data-calendar-target="modalTitle">Planifier ma commande</h3>
              <button type="button" class="text-gray-400 hover:text-gray-600" data-action="click->calendar#closeModal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <!-- Product list -->
            <div class="space-y-3 max-h-[50vh] overflow-y-auto" data-calendar-target="productList">
              <!-- Products will be rendered here by Stimulus -->
            </div>

            <!-- Total -->
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
              <span class="font-semibold text-gray-900">Total:</span>
              <span class="text-xl font-bold text-green-600" data-calendar-target="modalTotal">0,00 €</span>
            </div>

            <!-- Balance indicator -->
            <div data-calendar-target="balanceIndicator" class="mt-2 text-sm"></div>
          </div>

          <!-- Actions -->
          <div class="px-6 py-4 bg-gray-50 flex justify-between">
            <button type="button"
                    class="px-4 py-2 text-red-600 hover:text-red-700"
                    data-action="click->calendar#deleteOrder">
              Vider
            </button>
            <div class="flex gap-2">
              <button type="button"
                      class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                      data-action="click->calendar#closeModal">
                Annuler
              </button>
              <button type="button"
                      class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                      data-action="click->calendar#saveOrder"
                      data-calendar-target="saveBtn">
                Enregistrer
              </button>
            </div>
          </div>
        </div>

        <!-- État confirmation (injecté par JS) -->
        <div data-calendar-target="modalSuccess" class="hidden p-6"></div>
      </div>
    </div>
  </div>
</div>
