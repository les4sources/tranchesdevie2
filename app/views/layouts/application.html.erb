<!DOCTYPE html>
<html lang="fr" class="light">
  <head>
    <title><%= content_for(:title) || "Tranches de Vie" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

    <!-- Charger Stripe.js globalement pour eviter les erreurs "Stripe is not defined" avec Turbo -->
    <script src="https://js.stripe.com/v3/"></script>

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="font-display bg-background-light bg-white text-charcoal" data-controller="cart mobile-menu">
    <div data-controller="toast" class="pointer-events-none fixed inset-x-0 top-4 z-50 flex flex-col items-center px-4 sm:px-0">
      <div data-toast-target="container" class="flex w-full max-w-sm flex-col gap-3"></div>
    </div>

    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
      <div class="flex h-full grow flex-col">
        <div class="flex flex-1 justify-center px-4 py-5 sm:px-8 md:px-16 lg:px-24 xl:px-40">
          <div class="flex w-full max-w-[960px] flex-1 flex-col">
            <header class="flex items-center justify-between border-b border-gray-200 px-4 py-3">
              <div class="flex items-center gap-4 color-primary">
                <h1 class="text-2xl font-bold leading-tight tracking-[-0.015em]"><a href="/" class="hover:text-terracotta">Tranches de Vie</a></h1>
              </div>
              <% cart_count = current_cart_count %>
              <div class="hidden flex-1 items-center justify-end gap-8 md:flex">
                <div class="flex items-center gap-9">
                  <%= link_to "Nos pains et compagnie", catalog_path, class: "text-sm font-medium leading-normal text-charcoal hover:text-terracotta" %>
                  <%= link_to "À propos", a_propos_path, class: "text-sm font-medium leading-normal text-charcoal hover:text-terracotta" %>
                  <% if customer_signed_in? %>
                    <%= link_to "Mon compte", customers_account_path, class: "text-sm font-medium leading-normal text-charcoal hover:text-terracotta" %>
                  <% else %>
                    <%= link_to "Connexion", customer_login_path, class: "text-sm font-medium leading-normal text-charcoal hover:text-terracotta" %>
                  <% end %>
                </div>
                <div class="relative" data-cart-target="miniCartWrapper" data-action="mouseenter->cart#openMiniCart mouseleave->cart#scheduleMiniCartClose">
                  <%= link_to cart_path,
                              class: "flex h-10 items-center justify-center gap-2 rounded-lg bg-gray-200/50 px-2.5 text-sm font-bold leading-normal text-charcoal transition hover:bg-gray-300/60",
                              data: { action: "focus->cart#openMiniCart blur->cart#scheduleMiniCartClose" } do %>
                    <span class="material-symbols-outlined">shopping_cart</span>
                    <span class="sr-only">Panier</span>
                    <span data-cart-target="count" class="inline-flex h-6 min-w-6 items-center justify-center rounded-full bg-black px-2 text-xs font-semibold text-white <%= 'hidden' if cart_count.zero? %>">
                      <%= cart_count %>
                    </span>
                  <% end %>
                  <div data-cart-target="miniCartPanel" class="cart-mini-panel absolute z-1000 right-0 mt-3 hidden w-80 rounded-2xl border border-gray-200 bg-white p-4 shadow-xl" data-action="mouseenter->cart#cancelMiniCartClose mouseleave->cart#scheduleMiniCartClose">
                    <div data-cart-target="miniCartContent">
                      <%= render "cart/mini_cart", items: current_cart_items, total_cents: current_cart_total_cents, subtotal_cents: current_cart_subtotal_cents, discount_cents: current_cart_discount_cents, customer: current_customer_for_cart, count: current_cart_count %>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" data-mobile-menu-target="button" data-action="click->mobile-menu#toggle" class="flex h-10 max-w-[480px] items-center justify-center gap-2 rounded-lg bg-transparent px-2.5 text-sm font-bold leading-normal text-charcoal md:hidden">
                <span class="material-symbols-outlined text-2xl">menu</span>
                <span class="sr-only">Ouvrir la navigation</span>
              </button>
            </header>

            <!-- Menu mobile -->
            <div data-mobile-menu-target="menu" class="fixed inset-0 z-50 hidden bg-white md:hidden">
              <div class="flex h-full flex-col">
                <div class="flex items-center justify-between border-b border-gray-200 px-4 py-3">
                  <h2 class="text-lg font-semibold text-charcoal">Menu</h2>
                  <button type="button" data-action="click->mobile-menu#close" class="flex h-10 items-center justify-center rounded-lg bg-transparent px-2.5 text-charcoal">
                    <span class="material-symbols-outlined text-2xl">close</span>
                    <span class="sr-only">Fermer la navigation</span>
                  </button>
                </div>
                <nav class="flex flex-1 flex-col gap-1 overflow-y-auto px-4 py-4">
                  <%= link_to "Nos pains et compagnie", catalog_path, class: "rounded-lg px-4 py-3 text-base font-medium text-charcoal hover:bg-gray-100", data: { action: "click->mobile-menu#close" } %>
                  <%= link_to "À propos", a_propos_path, class: "rounded-lg px-4 py-3 text-base font-medium text-charcoal hover:bg-gray-100", data: { action: "click->mobile-menu#close" } %>
                  <% if customer_signed_in? %>
                    <%= link_to "Mon compte", customers_account_path, class: "rounded-lg px-4 py-3 text-base font-medium text-charcoal hover:bg-gray-100", data: { action: "click->mobile-menu#close" } %>
                    <%= button_to "Déconnexion",
                          customer_logout_path,
                          method: :delete,
                          form: { class: "inline" },
                          class: "w-full rounded-lg px-4 py-3 text-left text-base font-medium text-charcoal hover:bg-gray-100 bg-transparent border-0 cursor-pointer",
                          data: { action: "click->mobile-menu#close" } %>
                  <% else %>
                    <%= link_to "Connexion", customer_login_path, class: "rounded-lg px-4 py-3 text-base font-medium text-charcoal hover:bg-gray-100", data: { action: "click->mobile-menu#close" } %>
                  <% end %>
                  <div class="mt-4 border-t border-gray-200 pt-4">
                    <%= link_to cart_path, class: "flex items-center justify-between rounded-lg px-4 py-3 text-base font-medium text-charcoal hover:bg-gray-100", data: { action: "click->mobile-menu#close" } do %>
                      <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined">shopping_cart</span>
                        <span>Panier</span>
                      </div>
                      <span class="inline-flex h-6 min-w-6 items-center justify-center rounded-full bg-[#224246] px-2 text-xs font-semibold text-white <%= 'hidden' if cart_count.zero? %>">
                        <%= cart_count %>
                      </span>
                    <% end %>
                  </div>
                </nav>
              </div>
            </div>

            <% if notice.present? %>
              <div class="mx-4 mt-6 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm font-medium text-green-800 sm:mx-10">
                <%= notice %>
        </div>
            <% end %>

            <% if alert.present? %>
              <div class="mx-4 mt-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm font-medium text-red-800 sm:mx-10">
                <%= alert %>
        </div>
      <% end %>

            <main class="flex flex-col gap-6 py-8 pb-24 md:pb-8">
              <%= yield %>
            </main>

            <footer class="relative mt-16 overflow-hidden rounded-3xl bg-gradient-to-br from-soft-cream via-[#faf6f2] to-[#f5ebe4] px-5 py-12 text-charcoal md:mt-20 md:py-16">
              <div class="footer-grain" aria-hidden="true"></div>
              <div class="relative mx-auto max-w-4xl">
                <div class="grid gap-10 md:grid-cols-[1fr,auto] md:items-center md:gap-16">
                  <div class="space-y-6">
                    <p class="footer-reveal-item text-xs font-semibold uppercase tracking-[0.2em] text-charcoal/60">Écrivez-nous</p>
                    <a href="mailto:boulangerie@les4sources.be" class="footer-reveal-item footer-email-link inline-block text-lg text-charcoal hover:text-terracotta focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-terracotta focus-visible:ring-offset-2 md:text-xl">boulangerie@les4sources.be</a>
                    <div class="footer-reveal-item mt-6 rounded-xl border border-terracotta/20 bg-white/50 px-4 py-3 text-left">
                      <p class="text-sm leading-relaxed text-charcoal/80">Nos produits sont élaborés dans un atelier où des noix et fruits à coque sont utilisés. En cas d'allergie, n'hésitez pas à nous contacter.</p>
                    </div>
                  </div>
                  <div class="footer-reveal-item flex flex-col items-start border-t border-terracotta/30 pt-8 md:border-t-0 md:border-l md:border-l-terracotta/30 md:pl-12 md:pt-0">
                    <span class="text-3xl font-normal text-charcoal md:text-4xl" style="font-family: 'Pacifico', cursive;">Tranches de Vie</span>
                    <div class="mt-2 flex items-center gap-3">
                      <%= image_tag "logo-les-4-sources-production.png", alt: "Les 4 Sources", class: "h-8 w-auto object-contain md:h-10" %>
                      <span class="text-sm font-medium tracking-[0.35em] text-charcoal/70">Les 4 Sources</span>
                    </div>
                    <span class="mt-4 block h-px w-12 bg-terracotta/50" aria-hidden="true"></span>
                  </div>
                </div>
              </div>
            </footer>
          </div>
        </div>
      </div>
    </div>

    <% unless controller_name == 'cart' && action_name == 'show' || controller_name == 'checkout' %>
      <div class="md:hidden">
        <%= link_to cart_path, class: "fixed inset-x-4 bottom-4 z-40 flex items-center justify-between rounded-full bg-[#224246] px-5 py-3 text-white shadow-lg transition hover:bg-[#224246]/90" do %>
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-2xl">shopping_cart</span>
            <span class="text-sm font-semibold uppercase tracking-wide">Voir le panier</span>
          </div>
          <span data-cart-target="count" class="inline-flex min-w-8 items-center justify-center rounded-full bg-white px-2 py-1 text-xs font-bold uppercase text-[#224246] <%= 'hidden' if cart_count.zero? %>">
            <%= cart_count %>
          </span>
        <% end %>
      </div>
    <% end %>
  </body>
</html>
