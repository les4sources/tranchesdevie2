<% content_for :title, @product.name %>

<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" class="mb-8">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
      <li>
        <%= link_to "Accueil", root_path, class: "hover:text-gray-700" %>
      </li>
      <li>
        <span class="material-symbols-outlined text-xs">chevron_right</span>
      </li>
      <li>
        <%= link_to "Nos pains et compagnie", catalog_path, class: "hover:text-gray-700" %>
      </li>
      <li>
        <span class="material-symbols-outlined text-xs">chevron_right</span>
      </li>
      <li>
        <span class="text-gray-900 font-medium"><%= product_category_heading(@product.category) %></span>
      </li>
      <li>
        <span class="material-symbols-outlined text-xs">chevron_right</span>
      </li>
      <li>
        <span class="text-gray-900 font-medium" aria-current="page"><%= @product.name %></span>
      </li>
    </ol>
  </nav>

  <div class="lg:grid lg:grid-cols-2 lg:gap-x-8 lg:items-start">
    <!-- Image gallery -->
    <div class="flex flex-col-reverse" data-controller="product-carousel" data-action="touchstart->product-carousel#touchStart touchmove->product-carousel#touchMove touchend->product-carousel#touchEnd">
      <!-- Image selector -->
      <% if @product_images.length > 1 %>
        <div class="mx-auto mt-6 hidden w-full max-w-2xl sm:block lg:max-w-none">
          <div class="grid grid-cols-4 gap-6" aria-label="Sélection d'image">
            <% @product_images.each_with_index do |image_data, index| %>
              <button
                type="button"
                class="relative flex h-24 cursor-pointer items-center justify-center rounded-md bg-white text-sm font-medium uppercase text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-terracotta <%= 'ring-2 ring-terracotta' if index == 0 %>"
                data-product-carousel-target="thumbnail"
                data-action="click->product-carousel#goToSlide"
                data-carousel-index="<%= index %>"
              >
                <span class="sr-only">Image <%= index + 1 %></span>
                <div class="absolute inset-0 overflow-hidden rounded-md">
                  <img src="<%= image_data[:url] %>" alt="<%= @product.name %> - Image <%= index + 1 %>" class="h-full w-full object-cover object-center">
                </div>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Main image carousel -->
      <div class="aspect-square w-full overflow-hidden rounded-lg bg-gray-100 relative">
        <% @product_images.each_with_index do |image_data, index| %>
          <div class="carousel-slide absolute inset-0 bg-cover bg-center transition-opacity duration-500" data-product-carousel-target="slide" style="background-image: url('<%= image_data[:url] %>'); opacity: <%= index == 0 ? '1' : '0' %>;"></div>
        <% end %>
        
        <!-- Navigation dots for mobile -->
        <% if @product_images.length > 1 %>
          <div class="absolute bottom-4 left-1/2 flex -translate-x-1/2 gap-3 z-10">
            <% @product_images.each_with_index do |_, index| %>
              <button type="button" class="carousel-dot h-3 w-3 rounded-full transition-all <%= index == 0 ? 'bg-white' : 'bg-white/60' %>" data-product-carousel-target="dot" data-action="click->product-carousel#goToSlide" data-carousel-index="<%= index %>" aria-label="Image <%= index + 1 %>"></button>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Product info -->
    <div class="mt-10 px-4 sm:mt-16 sm:px-0 lg:mt-0">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900"><%= @product.name %></h1>

      <div class="mt-3">
        <p class="text-3xl tracking-tight text-gray-900" data-price-display>
          <%= number_to_currency(@selected_variant.price_euros, unit: "€", separator: ",", delimiter: "") %>
        </p>
      </div>

      <!-- Description -->
      <div class="mt-6">
        <p class="text-base text-gray-700">
          <%= @product.name %> - Un produit artisanal de qualité, préparé avec soin par les artisans de Tranches de Vie.
        </p>
      </div>

      <!-- Availability -->
      <div class="mt-4">
        <div class="flex items-center gap-2 text-sm text-green-700">
          <span class="material-symbols-outlined text-lg">check_circle</span>
          <span>En stock et prêt à être commandé</span>
        </div>
      </div>

      <!-- Variant selection -->
      <div class="mt-8">
        <h2 class="sr-only">Poids</h2>
        <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2" <%= 'data-controller="variant-selector"' if @variants.length > 1 %>>
          <% @variants.each do |variant| %>
            <label class="relative flex rounded-lg border p-4 focus:outline-none <%= 'cursor-pointer' if @variants.length > 1 %> <%= 'cursor-default opacity-75' if @variants.length == 1 %> <%= 'border-green-500 bg-green-50' if variant.id == @selected_variant.id %> <%= 'border-gray-300 hover:bg-gray-50' if @variants.length > 1 && variant.id != @selected_variant.id %> <%= 'border-gray-300' if @variants.length == 1 %>" <%= 'data-variant-selector-target="option" data-action="click->variant-selector#select"' if @variants.length > 1 %> data-variant-id="<%= variant.id %>" data-variant-price="<%= variant.price_euros %>">
              <input type="radio" name="variant" value="<%= variant.id %>" class="sr-only" <%= 'checked' if variant.id == @selected_variant.id %> <%= 'disabled' if @variants.length == 1 %>>
              <div class="flex flex-1">
                <div class="flex flex-col">
                  <span class="block text-sm font-medium text-gray-900"><%= variant.name %></span>
                  <span class="mt-1 block text-sm text-gray-500"><%= number_to_currency(variant.price_euros, unit: "€", separator: ",", delimiter: "") %></span>
                </div>
              </div>
              <% if variant.id == @selected_variant.id %>
                <span class="material-symbols-outlined text-green-600 absolute top-4 right-4">check_circle</span>
              <% end %>
              <span class="pointer-events-none absolute -inset-px rounded-lg border-2 <%= 'border-green-500' if variant.id == @selected_variant.id %>" aria-hidden="true"></span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Add to cart form -->
      <div class="mt-8" data-controller="quantity-selector">
        <%= form_with url: cart_add_path, method: :post, local: true, data: { action: "submit->cart#add" }, class: "flex flex-col gap-4" do |f| %>
          <%= f.hidden_field :product_variant_id, value: @selected_variant.id, data: { variant_selector_target: "variantInput" } %>
          <%= f.hidden_field :qty, value: 1, data: { quantity_selector_target: "input" } %>
          
          <!-- Quantity selector -->
          <div>
            <label class="sr-only">Quantité</label>
            <div class="flex items-center gap-3">
              <span class="text-sm font-medium text-gray-900">Quantité</span>
              <div class="flex items-center gap-2">
                <button type="button" data-action="click->quantity-selector#decrement" class="inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-300 text-lg font-semibold text-gray-700 hover:bg-gray-50 transition focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                  &minus;
                </button>
                <span class="inline-flex items-center justify-center h-10 min-w-[3rem] rounded-lg bg-gray-100 text-sm font-semibold text-gray-900" data-quantity-selector-target="display">
                  1
                </span>
                <button type="button" data-action="click->quantity-selector#increment" class="inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-300 text-lg font-semibold text-gray-700 hover:bg-gray-50 transition focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                  +
                </button>
              </div>
            </div>
          </div>
          
          <button type="submit" class="flex w-full items-center justify-center rounded-lg bg-green-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Ajouter dans mon panier
          </button>
        <% end %>
      </div>

      <!-- Guarantee -->
      <div class="mt-6">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <span class="material-symbols-outlined text-lg">verified</span>
          <span>Garantie qualité artisanale</span>
        </div>
      </div>
    </div>
  </div>
</div>

